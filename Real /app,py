import streamlit as st
from transformers import RobertaTokenizer, RobertaForSequenceClassification
import torch

# ---------------------- PAGE SETTINGS ----------------------
st.set_page_config(
    page_title="Fake Job Detector",
    page_icon="ğŸ•µï¸",
    layout="wide",
)

# ---------------------- SESSION STATE ----------------------
if "lang" not in st.session_state:
    st.session_state.lang = "EN"

if "theme" not in st.session_state:
    st.session_state.theme = "Light"

# ---------------------- LANGUAGE TOGGLE ----------------------
col1, col2 = st.columns([1, 1])

with col1:
    if st.button("ğŸŒ Ø¹Ø±Ø¨ÙŠ / English"):
        st.session_state.lang = "AR" if st.session_state.lang == "EN" else "EN"

with col2:
    if st.button("ğŸŒ“ Dark / Light"):
        st.session_state.theme = "Dark" if st.session_state.theme == "Light" else "Light"

# ---------------------- UI TEXT ----------------------
if st.session_state.lang == "EN":
    title = "ğŸ•µï¸ Fake Job Posting Detector"
    subtitle = "Enter a job description to check if it is REAL or FAKE."
    input_label = "Job Description"
    button_text = "Analyze Job Posting"
    real_label = "âœ” REAL JOB"
    fake_label = "âœ˜ FAKE JOB"
    conf_label = "Confidence"
    error_text = "Please enter a job description."
else:
    title = "ğŸ•µï¸ Ù†Ø¸Ø§Ù… ÙƒØ´Ù Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø§Ø­ØªÙŠØ§Ù„ÙŠØ©"
    subtitle = "Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø£Ùˆ Ù…Ø²ÙŠÙØ©."
    input_label = "ÙˆØµÙ Ø§Ù„ÙˆØ¸ÙŠÙØ©"
    button_text = "ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ©"
    real_label = "âœ” ÙˆØ¸ÙŠÙØ© Ø­Ù‚ÙŠÙ‚ÙŠØ©"
    fake_label = "âœ˜ ÙˆØ¸ÙŠÙØ© Ø§Ø­ØªÙŠØ§Ù„ÙŠØ©"
    conf_label = "Ù†Ø³Ø¨Ø© Ø§Ù„Ø«Ù‚Ø©"
    error_text = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ø§Ù„ÙˆØ¸ÙŠÙØ©."

# ---------------------- THEME COLORS ----------------------
if st.session_state.theme == "Dark":
    bg = "#1e1e1e"
    text = "white"
    box = "#2d2d2d"
else:
    bg = "#ffffff"
    text = "black"
    box = "#f5f5f5"

# ---------------------- CUSTOM CSS ----------------------
st.markdown(
    f"""
    <style>
        body {{
            background-color: {bg};
            color: {text};
        }}
        textarea {{
            background-color: {box} !important;
            color: {text} !important;
        }}
    </style>
    """,
    unsafe_allow_html=True,
)


# ---------------------- LOAD MODEL ----------------------
@st.cache_resource
def load_model():
    tokenizer = RobertaTokenizer.from_pretrained("model")
    model = RobertaForSequenceClassification.from_pretrained("model")
    model.eval()
    return tokenizer, model


tokenizer, model = load_model()

# ---------------------- UI ----------------------
st.markdown(f"<h1 style='text-align:center'>{title}</h1>", unsafe_allow_html=True)
st.markdown(f"<p style='text-align:center'>{subtitle}</p>", unsafe_allow_html=True)

text = st.text_area(input_label, height=200)

# ---------------------- PREDICT ----------------------
def predict(text):
    inputs = tokenizer(text, truncation=True, padding="max_length",
                       max_length=256, return_tensors="pt")

    with torch.no_grad():
        out = model(**inputs)
        logits = out.logits
        probs = torch.softmax(logits, dim=1)
        pred = torch.argmax(probs).item()

    return pred, probs[0][pred].item()

# ---------------------- BUTTON ----------------------
if st.button(button_text):
    if text.strip() == "":
        st.error(error_text)
    else:
        pred, conf = predict(text)
        if pred == 0:
            st.success(real_label)
        else:
            st.error(fake_label)

        st.write(f"**{conf_label}: {conf*100:.2f}%**")
